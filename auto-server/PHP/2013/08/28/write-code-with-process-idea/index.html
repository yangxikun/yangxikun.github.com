
<!DOCTYPE html>
<html lang="en"  xmlns:wb="http://open.weibo.com/wb">
  <head>
    <meta charset="utf-8">
    <title>带着操作系统的知识编程</title>
    <meta name="description" content="">
    <meta name="author" content="Rokety Yang">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Kun Blog</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/aboutMe.html">AboutMe</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>带着操作系统的知识编程 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>28 August 2013</span>
    </div>
    <div class="content">
      <h3 id='id15'>标题解释</h3>

<blockquote>
<p>在coding时,有时遇到的问题可以用操作系统的知识来解决.</p>
</blockquote>

<h3 id='id16'>问题描述</h3>

<blockquote>
<p>在一个PHP代码文件里有两段主要代码:其一是提供A数据(这部分代码给个昵称为ACode),其二是提供B数据(这部分代码给个昵称为BCode).其中BCode需要A数据中的部分数据(给个昵称为need)才能计算出B数据.</p>
</blockquote>

<blockquote>
<p>那么通常的做法就是先执行ACode得到A数据后,BCode再执行不就行了?可如果出现下面这种情况:</p>
</blockquote>

<blockquote>
<p>假设ACode执行到得到need的时间为t1,执行得到A数据的时间为t2,且t1小于t2很多,那么BCode就要等待很久才执行.也许你会想:那就把BCode放在ACode得到need数据之后执行,但这样的话,ACode剩下的那部分代码就要等到BCode执行完后再执行.</p>
</blockquote>

<blockquote>
<p>现在需要的实现是:ACode在得到need的时候,BCode就能很快开始执行,而ACode剩下的代码可以和BCode并行执行.</p>
</blockquote>

<h3 id='id17'>如何实现?</h3>

<blockquote>
<p>模拟操作系统进程同步的实现,这里将ACode比喻为ACode进程,BCode比喻为BCode进程.</p>
</blockquote>

<blockquote>
<p>从问题描述可以看出ACode进程和BCode进程之间存在同步关系,即BCode需要ACode计算出的need数据,且他们之间的制约关系为:直接相互制约(源于进程间的合作).</p>
</blockquote>

<blockquote>
<p>为了实现ACode进程和BCode进程能在一定程度上并行,需要提供一个输入缓冲区.当ACode进程计算得到need数据后就放入缓冲区中,BCode进程&#8221;监听&#8221;缓冲区,一旦有数据存入,便取出并计算出B数据.</p>
</blockquote>

<h3 id='php'>PHP代码要如何设计?</h3>

<blockquote>
<p>首先将ACode和BCode分为两个php代码文件,这里我模拟的是两个ajax并发请求,其中A请求从服务器获取A数据,B请求从服务器获取B数据,ACode和BCode之间的&#8221;缓冲区&#8221;使用memcached实现.</p>
</blockquote>

<blockquote>
<p>前台代码:</p>
</blockquote>
<div class='highlight'><pre><code class='html'><span class='lineno'> 1</span> <span class='cp'>&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span>
<span class='lineno'> 2</span> <span class='nt'>&lt;html&gt;</span>
<span class='lineno'> 3</span>     <span class='nt'>&lt;head&gt;</span>
<span class='lineno'> 4</span>     <span class='nt'>&lt;meta</span> <span class='na'>http-equiv=</span><span class='s'>&quot;Content-Type&quot;</span> <span class='na'>content=</span><span class='s'>&quot;text/html; charset=UTF-8&quot;</span><span class='nt'>&gt;</span>
<span class='lineno'> 5</span>     <span class='nt'>&lt;title&gt;</span>Wp Migration<span class='nt'>&lt;/title&gt;</span>
<span class='lineno'> 6</span>         <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;http://code.jquery.com/jquery-1.9.1.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
<span class='lineno'> 7</span>             <span class='nt'>&lt;script&gt;</span>
<span class='lineno'> 8</span>                 <span class='nx'>$</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(){</span>
<span class='lineno'> 9</span>                     <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#myForm&#39;</span><span class='p'>).</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;click&#39;</span><span class='p'>,</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>){</span>
<span class='lineno'>10</span>                          <span class='nx'>$</span><span class='p'>.</span><span class='nx'>ajax</span><span class='p'>({</span>
<span class='lineno'>11</span>                             <span class='nx'>url</span><span class='o'>:</span><span class='s1'>&#39;ACode.php&#39;</span><span class='p'>,</span>
<span class='lineno'>12</span>                             <span class='nx'>data</span><span class='o'>:</span><span class='nx'>$</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>serialize</span><span class='p'>(),</span>
<span class='lineno'>13</span>                             <span class='nx'>type</span><span class='o'>:</span><span class='s1'>&#39;GET&#39;</span><span class='p'>,</span>
<span class='lineno'>14</span>                             <span class='nx'>success</span><span class='o'>:</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>result</span><span class='p'>){</span>
<span class='lineno'>15</span>                                 <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#result&#39;</span><span class='p'>).</span><span class='nx'>append</span><span class='p'>(</span><span class='nx'>result</span><span class='p'>);</span>
<span class='lineno'>16</span>                             <span class='p'>}</span>
<span class='lineno'>17</span>                         <span class='p'>});</span>
<span class='lineno'>18</span>                          <span class='nx'>$</span><span class='p'>.</span><span class='nx'>ajax</span><span class='p'>({</span>
<span class='lineno'>19</span>                             <span class='nx'>url</span><span class='o'>:</span><span class='s1'>&#39;BCode.php&#39;</span><span class='p'>,</span>
<span class='lineno'>20</span>                             <span class='nx'>data</span><span class='o'>:</span><span class='nx'>$</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>serialize</span><span class='p'>(),</span>
<span class='lineno'>21</span>                             <span class='nx'>type</span><span class='o'>:</span><span class='s1'>&#39;GET&#39;</span><span class='p'>,</span>
<span class='lineno'>22</span>                             <span class='nx'>success</span><span class='o'>:</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>result</span><span class='p'>){</span>
<span class='lineno'>23</span>                                 <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;#result&#39;</span><span class='p'>).</span><span class='nx'>append</span><span class='p'>(</span><span class='nx'>result</span><span class='p'>);</span>
<span class='lineno'>24</span>                             <span class='p'>}</span>
<span class='lineno'>25</span>                         <span class='p'>});</span>
<span class='lineno'>26</span>                         <span class='k'>return</span> <span class='kc'>false</span><span class='p'>;</span>
<span class='lineno'>27</span>                     <span class='p'>});</span>
<span class='lineno'>28</span>                 <span class='p'>});</span>
<span class='lineno'>29</span>         <span class='nt'>&lt;/script&gt;</span>
<span class='lineno'>30</span>     <span class='nt'>&lt;/head&gt;</span>
<span class='lineno'>31</span>     <span class='nt'>&lt;body&gt;</span>
<span class='lineno'>32</span>         <span class='nt'>&lt;button</span> <span class='na'>id=</span><span class='s'>&quot;myForm&quot;</span><span class='nt'>&gt;</span>click<span class='nt'>&lt;/button&gt;</span>
<span class='lineno'>33</span>         <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;result&quot;</span><span class='nt'>&gt;&lt;/div&gt;</span>
<span class='lineno'>34</span>     <span class='nt'>&lt;/body&gt;</span>
<span class='lineno'>35</span> <span class='nt'>&lt;/html&gt;</span>
</code></pre>
</div>
<blockquote>
<p>ACode代码:</p>
</blockquote>
<div class='highlight'><pre><code class='php'><span class='lineno'> 1</span> <span class='cp'>&lt;?php</span> 
<span class='lineno'> 2</span>     <span class='nv'>$memcached</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>memcached</span><span class='p'>(</span> <span class='s1'>&#39;fetch&#39;</span> <span class='p'>);</span>
<span class='lineno'> 3</span>     <span class='nv'>$memcached</span><span class='o'>-&gt;</span><span class='na'>addServer</span><span class='p'>(</span> <span class='s1'>&#39;127.0.0.1&#39;</span><span class='p'>,</span> <span class='mi'>11211</span> <span class='p'>);</span>
<span class='lineno'> 4</span>     <span class='nv'>$key</span> <span class='o'>=</span> <span class='s1'>&#39;123456&#39;</span><span class='p'>;</span> <span class='c1'>//ACode和BCode通信的标识</span>
<span class='lineno'> 5</span>     <span class='nv'>$sellerId</span> <span class='o'>=</span> <span class='mi'>456789</span><span class='p'>;</span><span class='c1'>//need数据</span>
<span class='lineno'> 6</span>     <span class='k'>if</span> <span class='p'>(</span> <span class='nv'>$memcached</span><span class='o'>-&gt;</span><span class='na'>add</span><span class='p'>(</span> <span class='nv'>$key</span><span class='p'>,</span> <span class='nv'>$sellerId</span> <span class='p'>,</span> <span class='mi'>100</span> <span class='p'>)</span> <span class='p'>){</span>
<span class='lineno'> 7</span>         <span class='k'>echo</span> <span class='nb'>json_encode</span><span class='p'>(</span> <span class='k'>array</span><span class='p'>(</span> <span class='s1'>&#39;addOk&#39;</span> <span class='p'>)</span> <span class='p'>);</span>
<span class='lineno'> 8</span>     <span class='p'>}</span><span class='k'>else</span><span class='p'>{</span>
<span class='lineno'> 9</span>         <span class='k'>echo</span> <span class='nb'>json_encode</span><span class='p'>(</span> <span class='k'>array</span><span class='p'>(</span> <span class='s1'>&#39;hasAdd&#39;</span> <span class='p'>)</span> <span class='p'>);</span>
<span class='lineno'>10</span>     <span class='p'>}</span>
<span class='lineno'>11</span> <span class='cp'>?&gt;</span><span class='x' />
</code></pre>
</div>
<blockquote>
<p>BCode代码:</p>
</blockquote>
<div class='highlight'><pre><code class='php'><span class='lineno'>1</span> <span class='cp'>&lt;?php</span>
<span class='lineno'>2</span>     <span class='nv'>$memcached</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>memcached</span><span class='p'>(</span> <span class='s1'>&#39;fetch&#39;</span> <span class='p'>);</span>
<span class='lineno'>3</span>     <span class='nv'>$memcached</span><span class='o'>-&gt;</span><span class='na'>addServer</span><span class='p'>(</span> <span class='s1'>&#39;127.0.0.1&#39;</span><span class='p'>,</span> <span class='mi'>11211</span> <span class='p'>);</span>
<span class='lineno'>4</span>     <span class='nv'>$key</span> <span class='o'>=</span> <span class='s1'>&#39;123456&#39;</span><span class='p'>;</span> <span class='c1'>//ACode和BCode通信的标识</span>
<span class='lineno'>5</span>     <span class='k'>while</span> <span class='p'>(</span> <span class='p'>(</span><span class='nv'>$value</span> <span class='o'>=</span> <span class='nv'>$memcached</span><span class='o'>-&gt;</span><span class='na'>get</span><span class='p'>(</span> <span class='nv'>$key</span> <span class='p'>))</span> <span class='o'>==</span> <span class='k'>FALSE</span><span class='p'>)</span> <span class='p'>{</span><span class='c1'>//&quot;监听&quot;直到ACode将need数据存入&quot;缓冲区&quot;</span>
<span class='lineno'>6</span>         <span class='c1'>//这里可以用sleep()函数设置多久检测一次</span>
<span class='lineno'>7</span>     <span class='p'>}</span>
<span class='lineno'>8</span>     <span class='k'>echo</span> <span class='nb'>json_encode</span><span class='p'>(</span> <span class='k'>array</span><span class='p'>(</span><span class='nv'>$value</span><span class='p'>)</span> <span class='p'>);</span>
<span class='lineno'>9</span> <span class='cp'>?&gt;</span><span class='x' />
</code></pre>
</div>
    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#PHP-ref">
    		PHP <span>24</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#PHP应用-ref">PHP应用 <span>4</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/PHP/2013/08/24/php-val2" title="php 变量(下)">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/算法/2013/08/30/topological-sort" title="拓扑排序">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<div id="disqus_container">
    <a href="#" class="comment" onclick="return false;">点击查看评论</a>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'kunblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    $('#disqus_container .comment').on('click',function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        $('#disqus_container .comment').hide();
    });
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer class="footer">
        <p>&copy; 2013 Rokety Yang
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          Powered By <a href="https://github.com/">GitHub!</a>
        </p>
      </footer>

    </div>
  </body>
</html>

