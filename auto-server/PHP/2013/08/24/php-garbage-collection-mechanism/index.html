
<!DOCTYPE html>
<html lang="en"  xmlns:wb="http://open.weibo.com/wb">
  <head>
    <meta charset="utf-8">
    <title>PHP新的垃圾回收机制</title>
    <meta name="description" content="">
    <meta name="author" content="Rokety Yang">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Kun Blog</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/aboutMe.html">AboutMe</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>PHP新的垃圾回收机制 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>24 August 2013</span>
    </div>
    <div class="content">
      <p><em>参考自<a href='http://blog.csdn.net/phpkernel/article/details/5734743'>PHP新的垃圾回收机制:Zend GC详解</a>和<a href='http://php.net/manual/zh/features.gc.refcounting-basics.php'>引用计数基本知识</a></em></p>

<h3 id='id2'>什么算垃圾?</h3>

<blockquote>
<p>当一个变量的refcount_gc为0时,将会被作为垃圾进行回收处理.</p>
</blockquote>

<h3 id='_'>新的垃圾回收机制所要解决的问题: 顽固垃圾</h3>

<blockquote>
<p>什么是顽固垃圾?</p>
</blockquote>

<blockquote>
<blockquote>
<p>示例:当我们添加一个数组本身作为这个数组的元素时,代码如下:</p>
</blockquote>
</blockquote>
<div class='highlight'><pre><code class='php'><span class='lineno'>1</span> <span class='cp'>&lt;?php</span>
<span class='lineno'>2</span> <span class='nv'>$a</span> <span class='o'>=</span> <span class='k'>array</span><span class='p'>(</span> <span class='s1'>&#39;one&#39;</span> <span class='p'>);</span>
<span class='lineno'>3</span> <span class='nv'>$a</span><span class='p'>[]</span> <span class='o'>=&amp;</span> <span class='nv'>$a</span><span class='p'>;</span>
<span class='lineno'>4</span> <span class='nx'>xdebug_debug_zval</span><span class='p'>(</span> <span class='s1'>&#39;a&#39;</span> <span class='p'>);</span>
<span class='lineno'>5</span> <span class='cp'>?&gt;</span><span class='x' />
</code></pre>
</div>
<blockquote>
<blockquote>
<p>代码输出:</p>
</blockquote>
</blockquote>
<div class='highlight'><pre><code class='php'><span class='lineno'>1</span> <span class='cp'>&lt;?php</span>
<span class='lineno'>2</span> <span class='nx'>a</span><span class='o'>:</span> <span class='p'>(</span><span class='nx'>refcount</span><span class='o'>=</span><span class='mi'>2</span><span class='p'>,</span> <span class='nx'>is_ref</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>)</span><span class='o'>=</span><span class='k'>array</span> <span class='p'>(</span>
<span class='lineno'>3</span>    <span class='mi'>0</span> <span class='o'>=&gt;</span> <span class='p'>(</span><span class='nx'>refcount</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>,</span> <span class='nx'>is_ref</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>)</span><span class='o'>=</span><span class='s1'>&#39;one&#39;</span><span class='p'>,</span>
<span class='lineno'>4</span>   <span class='mi'>1</span> <span class='o'>=&gt;</span> <span class='p'>(</span><span class='nx'>refcount</span><span class='o'>=</span><span class='mi'>2</span><span class='p'>,</span> <span class='nx'>is_ref</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>)</span><span class='o'>=...</span>
<span class='lineno'>5</span> <span class='p'>)</span>
<span class='lineno'>6</span> <span class='cp'>?&gt;</span><span class='x' />
</code></pre>
</div>
<blockquote>
<blockquote>
<p>引用手册中的图解:</p>
</blockquote>
</blockquote>

<p><img alt='PHPGC' src='/assets/img/201308240101.png' /></p>

<blockquote>
<p>能看到数组变量 (a) 同时也是这个数组的第二个元素(1) 指向的变量容器中“refcount”为 2。上面的输出结果中的&#8221;&#8230;&#8220;说明发生了递归操作, 显然在这种情况下意味着&#8221;&#8230;&#8220;指向原始数组。</p>
</blockquote>

<blockquote>
<p>对一个变量调用unset，将删除这个符号，且它指向的变量容器中的引用次数也减1。所以，如果我们在执行完上面的代码后，对变量$a调用unset, 那么变量 $a 和数组元素 &#8220;1&#8221; 所指向的变量容器的引用次数减1, 从&#8221;2&#8221;变成&#8221;1&#8221;. 下例可以说明:</p>
</blockquote>
<div class='highlight'><pre><code class='php'><span class='lineno'>1</span> <span class='cp'>&lt;?php</span>
<span class='lineno'>2</span> <span class='p'>(</span><span class='nx'>refcount</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>,</span> <span class='nx'>is_ref</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>)</span><span class='o'>=</span><span class='k'>array</span> <span class='p'>(</span>
<span class='lineno'>3</span>    <span class='mi'>0</span> <span class='o'>=&gt;</span> <span class='p'>(</span><span class='nx'>refcount</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>,</span> <span class='nx'>is_ref</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>)</span><span class='o'>=</span><span class='s1'>&#39;one&#39;</span><span class='p'>,</span>
<span class='lineno'>4</span>   <span class='mi'>1</span> <span class='o'>=&gt;</span> <span class='p'>(</span><span class='nx'>refcount</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>,</span> <span class='nx'>is_ref</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>)</span><span class='o'>=...</span>
<span class='lineno'>5</span> <span class='p'>)</span>
<span class='lineno'>6</span> <span class='cp'>?&gt;</span><span class='x' />
</code></pre>
</div>
<blockquote>
<blockquote>
<p>引用手册中的图解:</p>
</blockquote>
</blockquote>

<p><img alt='PHPCG' src='/assets/img/201308240102.png' /></p>

<blockquote>
<p>所以新的垃圾回收机制要处理的就是类似以上示例的顽固垃圾.</p>
</blockquote>

<h3 id='gc'>新的GC算法</h3>

<blockquote>
<p>在较新的PHP手册中有简单的介绍新的GC使用的垃圾清理算法，这个算法名为<strong>Concurrent Cycle Collection in Reference Counted Systems</strong> 这里不详细介绍此算法，根据手册中的内容来先简单的介绍一下思路：</p>
</blockquote>

<blockquote>
<p>首先我们有几个基本的准则：</p>
</blockquote>

<blockquote>
<blockquote>
<ol>
<li>如果一个zval的refcount_gc增加，那么此zval还在使用，不属于垃圾</li>

<li>如果一个zval的refcount_gc减少到0， 那么zval可以被释放掉，不属于垃圾</li>

<li>如果一个zval的refcount_gc减少之后大于0，那么此zval还不能被释放，此zval可能成为一个垃圾</li>
</ol>
</blockquote>
</blockquote>

<blockquote>
<p>只有在准则3下，GC才会把zval收集起来，然后通过新的算法来判断此zval是否为垃圾。</p>
</blockquote>

<blockquote>
<p>那么如何判断这么一个变量是否为真正的垃圾呢？</p>
</blockquote>

<blockquote>
<blockquote>
<p>简单的说，就是对此zval中的每个元素进行一次refcount减1操作，操作完成之后，如果zval的refcount=0，那么这个zval就是一个垃圾。</p>
</blockquote>
</blockquote>

<blockquote>
<p>引用手册中的图解:</p>
</blockquote>

<p><img alt='PHPCG' src='/assets/img/201308240103.jpeg' /></p>

<blockquote>
<p>A：为了避免每次变量的refcount_gc减少的时候都调用GC的算法进行垃圾判断，此算法会先把所有前面准则3情况下的zval节点放入一个节点(root)缓冲区(root buffer)，并且将这些zval节点标记成紫色，同时算法必须确保每一个zval节点在缓冲区中之出现一次。当缓冲区被节点塞满的时候，GC才开始开始对缓冲区中的zval节点进行垃圾判断。</p>
</blockquote>

<blockquote>
<p>B：当缓冲区满了之后，算法以深度优先对每一个zval节点所包含的zval进行减1操作，为了确保不会对同一个zval的refcount重复执行减1操作，一旦zval的refcount减1之后会将zval标记成灰色。</p>
</blockquote>

<blockquote>
<p>C：算法再次以深度优先判断每一个节点包含的zval的值，如果zval的refcount等于0，那么将其标记成白色<em>图中明明为蓝色!</em>(代表垃圾)，如果zval的refcount大于0，那么将对此zval以及其包含的zval进行refcount加1操作，这个是对非垃圾的还原操作，同时将这些zval的颜色变成黑色(zval的默认颜色属性).</p>
</blockquote>

<blockquote>
<p>D：遍历zval节点，将C中标记成白色的节点zval释放掉。</p>
</blockquote>

<h3 id='phpgc'>PHP中运用新的GC的算法</h3>

<blockquote>
<p>在PHP中，GC默认是开启的，你可以通过ini文件中的 zend.enable_gc 项来开启或则关闭GC。当GC开启的时候，垃圾分析算法将在节点缓冲区(roots buffer)满了之后启动。缓冲区默认可以放10,000个节点，当然你也可以通过修改Zend/zend_gc.c中的GC_ROOT_BUFFER_MAX_ENTRIES 来改变这个数值，需要重新编译链接PHP。当GC关闭的时候，垃圾分析算法就不会运行，但是相关节点还会被放入节点缓冲区，这个时候如果缓冲区节点已经放满，那么新的节点就不会被记录下来，这些没有被记录下来的节点就永远也不会被垃圾分析算法分析。如果这些节点中有循环引用，那么有可能产生内存泄漏。之所以在GC关闭的时候还要记录这些节点，是因为简单的记录这些节点比在每次产生节点的时候判断GC是否开启更快，另外GC是可以在脚本运行中开启的，所以记录下这些节点，在代码运行的某个时候如果又开启了GC，这些节点就能被分析算法分析。当然垃圾分析算法是一个比较耗时的操作。</p>
</blockquote>

<blockquote>
<p>在PHP代码中我们可以通过gc_enable()和gc_disable()函数来开启和关闭GC，也可以通过调用gc_collect_cycles()在节点缓冲区未满的情况下强制执行垃圾分析算法。这样用户就可以在程序的某些部分关闭或则开启GC，也可强制进行垃圾分析算法。</p>
</blockquote>
    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#PHP-ref">
    		PHP <span>24</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#PHP底层-ref">PHP底层 <span>7</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/PHP/2013/08/23/php-internal" title="PHP 底层机制">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/PHP/2013/08/24/php-life" title="PHP生命周期">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<div id="disqus_container">
    <a href="#" class="comment" onclick="return false;">点击查看评论</a>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'kunblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    $('#disqus_container .comment').on('click',function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        $('#disqus_container .comment').hide();
    });
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer class="footer">
        <p>&copy; 2013 Rokety Yang
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          Powered By <a href="https://github.com/">GitHub!</a>
        </p>
      </footer>

    </div>
  </body>
</html>

