
<!DOCTYPE html>
<html lang="en"  xmlns:wb="http://open.weibo.com/wb">
  <head>
    <meta charset="utf-8">
    <title>php 变量(下)</title>
    <meta name="description" content="">
    <meta name="author" content="Rokety Yang">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/pygments.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Kun Blog</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/aboutMe.html">AboutMe</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>php 变量(下) </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>24 August 2013</span>
    </div>
    <div class="content">
      <p><em>学习自<a href='http://www.php-internals.com/book/'>TIPI</a>,做个小结,内容从TIPI中选取</em></p>

<h3 id='id8'>常量</h3>

<blockquote>
<p>常量是在变量的zval结构的基础上添加了一些额外的元素,内部结构如下。</p>
</blockquote>
<div class='highlight'><pre><code class='cpp'><span class='lineno'>1</span> <span class='k'>typedef</span> <span class='k'>struct</span> <span class='n'>_zend_constant</span> <span class='p'>{</span>
<span class='lineno'>2</span>     <span class='n'>zval</span> <span class='n'>value</span><span class='p'>;</span> <span class='cm'>/* zval结构，PHP内部变量的存储结构 */</span>
<span class='lineno'>3</span>     <span class='kt'>int</span> <span class='n'>flags</span><span class='p'>;</span>  <span class='cm'>/* 常量的标记如 CONST_PERSISTENT | CONST_CS | CONST_CT_SUBST*/</span>
<span class='lineno'>4</span>     <span class='kt'>char</span> <span class='o'>*</span><span class='n'>name</span><span class='p'>;</span> <span class='cm'>/* 常量名称 */</span>
<span class='lineno'>5</span>     <span class='n'>uint</span> <span class='n'>name_len</span><span class='p'>;</span>  
<span class='lineno'>6</span>     <span class='kt'>int</span> <span class='n'>module_number</span><span class='p'>;</span>  <span class='cm'>/* 模块号 */</span>
<span class='lineno'>7</span> <span class='p'>}</span> <span class='n'>zend_constant</span><span class='p'>;</span>
</code></pre>
</div>
<blockquote>
<p>flags值说明:</p>
</blockquote>

<blockquote>
<blockquote>
<p>默认值为CONT_CS,表示大小写敏感 CONST_PERSISTENT表示常量要持久化 CONST_CT_SUBST在编译时可被替换,在PHP内核中这些常量包括：TRUE、FALSE、NULL、ZEND_THREAD_SAFE和ZEND_DEBUG_BUILD五个。</p>
</blockquote>
</blockquote>

<h3 id='id9'>标准常量的初始化</h3>

<blockquote>
<p>通过define()函数定义的常量的模块编号都是PHP_USER_CONSTANT，这表示是用户定义的常量。 除此之外我们在平时使用较多的常量：如错误报告级别E_ALL, E_WARNING等常量就有点不同了。 这些是PHP内置定义的常量，他们属于标准常量。</p>
</blockquote>

<blockquote>
<p>在Zend引擎启动后，会执行如下的标准常量注册操作,<code>php_module_startup() -&gt; zend_startup() -&gt; zend_register_standard_constants()</code>。</p>
</blockquote>
<div class='highlight'><pre><code class='cpp'><span class='lineno'>1</span> <span class='kt'>void</span> <span class='nf'>zend_register_standard_constants</span><span class='p'>(</span><span class='n'>TSRMLS_D</span><span class='p'>)</span>
<span class='lineno'>2</span> <span class='p'>{</span>
<span class='lineno'>3</span>     <span class='p'>...</span> <span class='c1'>//  若干常量以REGISTER_MAIN_LONG_CONSTANT设置，</span>
<span class='lineno'>4</span>     <span class='n'>REGISTER_MAIN_LONG_CONSTANT</span><span class='p'>(</span><span class='s'>&quot;E_ALL&quot;</span><span class='p'>,</span> <span class='n'>E_ALL</span><span class='p'>,</span> <span class='n'>CONST_PERSISTENT</span> <span class='o'>|</span> <span class='n'>CONST_CS</span><span class='p'>);</span>
<span class='lineno'>5</span>     <span class='p'>...</span>
<span class='lineno'>6</span> <span class='p'>}</span>
</code></pre>
</div>
<blockquote>
<p>REGISTER_MAIN_LONG_CONSTANT()是一个宏，用于注册一个长整形数字的常量，因为C是强类型 语言，不同类型的数据等分别处理，以上的宏展开到下面这个函数。</p>
</blockquote>
<div class='highlight'><pre><code class='cpp'><span class='lineno'> 1</span> <span class='n'>ZEND_API</span> <span class='kt'>void</span> <span class='nf'>zend_register_long_constant</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span> <span class='o'>*</span><span class='n'>name</span><span class='p'>,</span> <span class='n'>uint</span> <span class='n'>name_len</span><span class='p'>,</span>
<span class='lineno'> 2</span>         <span class='kt'>long</span> <span class='n'>lval</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>flags</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>module_number</span> <span class='n'>TSRMLS_DC</span><span class='p'>)</span>
<span class='lineno'> 3</span> <span class='p'>{</span>
<span class='lineno'> 4</span>     <span class='n'>zend_constant</span> <span class='n'>c</span><span class='p'>;</span>
<span class='lineno'> 5</span>  
<span class='lineno'> 6</span>     <span class='n'>c</span><span class='p'>.</span><span class='n'>value</span><span class='p'>.</span><span class='n'>type</span> <span class='o'>=</span> <span class='n'>IS_LONG</span><span class='p'>;</span>
<span class='lineno'> 7</span>     <span class='n'>c</span><span class='p'>.</span><span class='n'>value</span><span class='p'>.</span><span class='n'>value</span><span class='p'>.</span><span class='n'>lval</span> <span class='o'>=</span> <span class='n'>lval</span><span class='p'>;</span>
<span class='lineno'> 8</span>     <span class='n'>c</span><span class='p'>.</span><span class='n'>flags</span> <span class='o'>=</span> <span class='n'>flags</span><span class='p'>;</span>
<span class='lineno'> 9</span>     <span class='n'>c</span><span class='p'>.</span><span class='n'>name</span> <span class='o'>=</span> <span class='n'>zend_strndup</span><span class='p'>(</span><span class='n'>name</span><span class='p'>,</span> <span class='n'>name_len</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>);</span>
<span class='lineno'>10</span>     <span class='n'>c</span><span class='p'>.</span><span class='n'>name_len</span> <span class='o'>=</span> <span class='n'>name_len</span><span class='p'>;</span>
<span class='lineno'>11</span>     <span class='n'>c</span><span class='p'>.</span><span class='n'>module_number</span> <span class='o'>=</span> <span class='n'>module_number</span><span class='p'>;</span>
<span class='lineno'>12</span>     <span class='n'>zend_register_constant</span><span class='p'>(</span><span class='o'>&amp;</span><span class='n'>c</span> <span class='n'>TSRMLS_CC</span><span class='p'>);</span>
<span class='lineno'>13</span> <span class='p'>}</span>
</code></pre>
</div>
<blockquote>
<p>代码很容易理解，前面看到注册内置常量都是用了CONST_PERSISTENT标志位，也就是说， 这些常量都是持久化常量。</p>
</blockquote>

<h3 id='id10'>魔术常量</h3>

<blockquote>
<p>PHP提供了大量的预定义常量，有一些是内置的，也有一些是扩展提供的，只有在加载了这些扩展库时才会出现。</p>
</blockquote>

<blockquote>
<p>不过PHP中有七个魔术常量，他们的值其实是变化的，它们的值随着它们在代码中的位置改变而改变。 所以称他们为魔术常量。例如 <strong>LINE</strong> 的值就依赖于它在脚本中所处的行来决定。 这些特殊的常量不区分大小写,分别有:__LINE__,__FILE__,__DIR__,__FUNCTION____CLASS__,__METHOD__,__NAMESPACE__。</p>
</blockquote>

<blockquote>
<p>PHP内核会在词法解析时将这些常量的内容赋值进行替换，而不是在运行时进行分析。这些常量其实相当于一个占位符，在词法解析时这些占位符就被替换成实际的值。</p>
</blockquote>

<h3 id='id11'>预定义变量</h3>

<blockquote>
<p>诸如$_GET，$_POST，$_SERVER，$_FILES等变量都是PHP的预定义变量,PHP是在脚本运行之前就将预定义变量加入到了符号表。</p>
</blockquote>

<h3 id='id12'>静态变量</h3>

<blockquote>
<p>Zend为每个函数(准确的说是zend_op_array)分配了一个私有的符号表来保存该函数的静态变量。</p>
</blockquote>

<h3 id='id13'>类型提示的实现</h3>

<blockquote>
<p>PHP中的类型提示功能只能用于参数为对象的提示，而无法用于为整数，字串，浮点等类型提示。在PHP5.1之后，PHP支持对数组的类型提示。</p>
</blockquote>
<div class='highlight'><pre><code class='cpp'><span class='lineno'>1</span> <span class='n'>function</span> <span class='nf'>array_print</span><span class='p'>(</span><span class='n'>Array</span> <span class='err'>$</span><span class='n'>arr</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>2</span>     <span class='n'>print_r</span><span class='p'>(</span><span class='err'>$</span><span class='n'>arr</span><span class='p'>);</span>
<span class='lineno'>3</span> <span class='p'>}</span>
<span class='lineno'>4</span> <span class='n'>array_print</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>);</span>
</code></pre>
</div>
<blockquote>
<p>以上代码会在运行时产生错误报告。</p>
</blockquote>
<div class='highlight'><pre><code class='cpp'><span class='lineno'>1</span> <span class='n'>function</span> <span class='nf'>array_print</span><span class='p'>(</span><span class='n'>Array</span> <span class='err'>$</span><span class='n'>arr</span> <span class='o'>=</span> <span class='mi'>1</span><span class='p'>)</span> <span class='p'>{</span>
<span class='lineno'>2</span>     <span class='n'>print_r</span><span class='p'>(</span><span class='err'>$</span><span class='n'>arr</span><span class='p'>);</span>
<span class='lineno'>3</span> <span class='p'>}</span>
<span class='lineno'>4</span> <span class='n'>array_print</span><span class='p'>(</span><span class='n'>array</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>));</span>
</code></pre>
</div>
<blockquote>
<p>以上代码会在中间代码生成时产生错误报告,具体实现翻书吧。</p>
</blockquote>

<h3 id='id14'>变量的作用域</h3>

<blockquote>
<p>PHP中的变量都保存在符号表中,对于全局变量和局部变量,分别存放在symbol_table和相对应的active_symbol_table.</p>
</blockquote>

<blockquote>
<p>变量的作用域是使用不同的符号表来实现的，于是顶层的全局变量在函数内部使用时， 需要先使用global语句来将变量“挪”到函数独立的*active_symbol_table中， 即变量的跨域操作。</p>
</blockquote>
    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#PHP-ref">
    		PHP <span>24</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#PHP底层-ref">PHP底层 <span>7</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/PHP/2013/08/24/php-val" title="php 变量(上)">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/PHP/2013/08/28/write-code-with-process-idea" title="带着操作系统的知识编程">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<div id="disqus_container">
    <a href="#" class="comment" onclick="return false;">点击查看评论</a>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'kunblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    $('#disqus_container .comment').on('click',function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        $('#disqus_container .comment').hide();
    });
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer class="footer">
        <p>&copy; 2013 Rokety Yang
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          Powered By <a href="https://github.com/">GitHub!</a>
        </p>
      </footer>

    </div>
  </body>
</html>

